<mat-card class="table-card">
  <mat-card-header>
    <mat-card-title i18n="@@entriesTitle">Einträge</mat-card-title>
    <mat-card-subtitle i18n="@@entriesCount"
      >{{ entries().length }} Einträge</mat-card-subtitle
    >
    <span class="header-spacer"></span>
    <button
      type="button"
      mat-button
      class="toggle-source"
      (click)="toggleSourceColumn()"
      i18n="@@sourceColumnToggle"
    >
      <mat-icon>{{
        showSourceColumn() ? 'visibility' : 'visibility_off'
      }}</mat-icon>
      Quelle
    </button>
    <button
      type="button"
      class="add-btn"
      mat-flat-button
      (click)="openCreateDialog()"
      i18n="@@createNewEntry"
    >
      <mat-icon>add</mat-icon>
      Neu
    </button>
  </mat-card-header>

  <mat-card-content>
    @if (isBrowser) {
      <cdk-virtual-scroll-viewport
        class="table-wrap"
        [itemSize]="56"
        [minBufferPx]="280"
        [maxBufferPx]="560"
      >
        <ng-container *ngTemplateOutlet="entriesTable"></ng-container>
      </cdk-virtual-scroll-viewport>
    } @else {
      <div class="table-wrap">
        <ng-container *ngTemplateOutlet="entriesTable"></ng-container>
      </div>
    }

    @if (!entries().length) {
      <p class="empty" i18n="@@noEntriesInSelectedRange">
        Keine Einträge im gewählten Zeitraum.
      </p>
    }
  </mat-card-content>
</mat-card>

<ng-template #entriesTable>
  <mat-table
    [dataSource]="dataSource"
    matSort
    [matSortActive]="'timestamp'"
    [matSortDirection]="'desc'"
    class="mat-elevation-z8"
  >
    <ng-container matColumnDef="timestamp">
      <mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@colTime"
        >Zeit</mat-header-cell
      >
      <mat-cell *matCellDef="let entry">{{
        entry.timestamp | date: 'dd.MM.yyyy, HH:mm'
      }}</mat-cell>
    </ng-container>

    <ng-container matColumnDef="reps">
      <mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@colReps"
        >Reps</mat-header-cell
      >
      <mat-cell *matCellDef="let entry"
        ><span>{{ entry.reps }}</span></mat-cell
      >
    </ng-container>

    <ng-container matColumnDef="type">
      <mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@colType"
        >Typ</mat-header-cell
      >
      <mat-cell *matCellDef="let entry"
        ><span>{{ entry.type || 'Standard' }}</span></mat-cell
      >
    </ng-container>

    <ng-container matColumnDef="source">
      <mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@colSource"
        >Quelle</mat-header-cell
      >
      <mat-cell *matCellDef="let entry"
        ><span>{{ entry.source }}</span></mat-cell
      >
    </ng-container>

    <ng-container matColumnDef="actions">
      <mat-header-cell *matHeaderCellDef i18n="@@colActions"
        >Aktion</mat-header-cell
      >
      <mat-cell *matCellDef="let entry" class="actions">
        <button
          type="button"
          mat-mini-fab
          aria-label="Bearbeiten"
          i18n-aria-label="@@editAria"
          title="Bearbeiten"
          i18n-title="@@editTitle"
          (click)="openEditDialog(entry)"
        >
          <mat-icon>edit</mat-icon>
        </button>
        <button
          type="button"
          class="danger"
          mat-mini-fab
          aria-label="Löschen"
          i18n-aria-label="@@deleteAria"
          title="Löschen"
          i18n-title="@@deleteTitle"
          [disabled]="isBusy('delete', entry._id)"
          (click)="remove.emit(entry._id)"
        >
          @if (isBusy('delete', entry._id)) {
            <mat-spinner diameter="14"></mat-spinner>
          } @else {
            <mat-icon>delete</mat-icon>
          }
        </button>
      </mat-cell>
    </ng-container>

    <mat-header-row
      *matHeaderRowDef="displayedColumns(); sticky: true"
    ></mat-header-row>
    <mat-row
      matRipple
      *matRowDef="let row; columns: displayedColumns()"
    ></mat-row>
  </mat-table>
</ng-template>

<ng-template #createDialog>
  <h2 mat-dialog-title i18n="@@createDialogTitle">Neuen Eintrag anlegen</h2>

  <mat-dialog-content class="create-dialog-content">
    <mat-form-field appearance="outline">
      <mat-label i18n="@@timestampLabel">Zeitpunkt</mat-label>
      <input
        matInput
        type="datetime-local"
        [value]="newTimestamp()"
        (input)="newTimestamp.set(asValue($event))"
        required
      />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@repsLabel">Reps</mat-label>
      <input
        matInput
        type="number"
        min="1"
        [value]="newReps()"
        (input)="newReps.set(asValue($event))"
        required
      />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@typeLabel">Typ</mat-label>
      <input
        type="text"
        matInput
        [formControl]="newTypeControl"
        [matAutocomplete]="typeAuto"
        placeholder="Pick one / Custom"
        i18n-placeholder="@@typePlaceholder"
      />
      <mat-autocomplete #typeAuto="matAutocomplete">
        @for (option of filteredTypeOptions$ | async; track option) {
          <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@sourceLabel">Quelle</mat-label>
      <input
        type="text"
        matInput
        [formControl]="newSourceControl"
        [matAutocomplete]="sourceAuto"
        placeholder="web / whatsapp / Custom"
        i18n-placeholder="@@sourcePlaceholder"
      />
      <mat-autocomplete #sourceAuto="matAutocomplete">
        @for (option of filteredSourceOptions$ | async; track option) {
          <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button
      type="button"
      mat-button
      (click)="dialog.closeAll()"
      i18n="@@cancel"
    >
      Abbrechen
    </button>
    <button
      type="button"
      mat-flat-button
      [disabled]="isCreateBusy()"
      (click)="submitCreate()"
      i18n="@@saveEntry"
    >
      @if (isCreateBusy()) {
        <mat-spinner diameter="14"></mat-spinner>
      } @else {
        Speichern
      }
    </button>
  </mat-dialog-actions>
</ng-template>

<ng-template #editDialog>
  <h2 mat-dialog-title i18n="@@editDialogTitle">Eintrag bearbeiten</h2>

  <mat-dialog-content class="create-dialog-content">
    <mat-form-field appearance="outline">
      <mat-label i18n="@@timestampLabel">Zeitpunkt</mat-label>
      <input
        matInput
        type="datetime-local"
        [value]="editTimestampById()"
        (input)="setEditTimestampById(asValue($event))"
        required
      />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@repsLabel">Reps</mat-label>
      <input
        matInput
        type="number"
        min="1"
        [value]="editRepsById()"
        (input)="setEditRepsById(asValue($event))"
        required
      />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@typeLabel">Typ</mat-label>
      <input
        type="text"
        matInput
        [formControl]="editTypeControl"
        [matAutocomplete]="editTypeAuto"
        placeholder="Pick one / Custom"
        i18n-placeholder="@@typePlaceholder"
      />
      <mat-autocomplete #editTypeAuto="matAutocomplete">
        @for (option of filteredEditTypeOptions$ | async; track option) {
          <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label i18n="@@sourceLabel">Quelle</mat-label>
      <input
        type="text"
        matInput
        [formControl]="editSourceControl"
        [matAutocomplete]="editSourceAuto"
        placeholder="web / whatsapp / Custom"
        i18n-placeholder="@@sourcePlaceholder"
      />
      <mat-autocomplete #editSourceAuto="matAutocomplete">
        @for (option of filteredEditSourceOptions$ | async; track option) {
          <mat-option [value]="option">{{ option }}</mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button type="button" mat-button (click)="cancelEdit()" i18n="@@cancel">
      Abbrechen
    </button>
    <button
      type="button"
      mat-flat-button
      [disabled]="!editingId() || isBusy('update', editBusyId())"
      (click)="saveFromDialog()"
      i18n="@@saveChanges"
    >
      @if (editingId() && isBusy('update', editBusyId())) {
        <mat-spinner diameter="14"></mat-spinner>
      } @else {
        Speichern
      }
    </button>
  </mat-dialog-actions>
</ng-template>
