# Nginx front proxy for pushup-stats-service i18n deployment
#
# Goal:
# - German is default at / (no prefix)
# - English is served at /en
# - Language is chosen by (1) cookie "language" (highest prio), else (2) Accept-Language
# - /api, /socket.io and /health are always routed to the DE backend (single API source)
#
# Backends (SSR):
# - DE SSR: node dist/web/server/server.mjs      (PORT=8788)
# - EN SSR: node dist/web/server/en/server.mjs   (PORT=8789)
#
# Put this into e.g. /etc/nginx/sites-available/pushup and enable it.
# Adjust server_name, TLS, etc.

# Decide locale: cookie overrides Accept-Language.
# Cookie examples:
# - language=en
# - language=en-US
# - language=de
map $cookie_language $lang_from_cookie {
  default "";
  ~*^en  en;
  ~*^de  de;
}

map $http_accept_language $lang_from_header {
  default de;
  ~*\ben\b en;
}

# Final locale
map $lang_from_cookie $lang {
  default $lang_from_header;
  en en;
  de de;
}

upstream pushup_de {
  server 127.0.0.1:8788;
  keepalive 32;
}

upstream pushup_en {
  server 127.0.0.1:8789;
  keepalive 32;
}

server {
  # This nginx is meant to be the front door on the same port your tailnet URL exposes.
  # According to current setup: pushup.tail433f94.ts.net -> localhost:8787
  listen 8787;
  server_name pushup.tail433f94.ts.net;

  # ---- API / infra always -> DE backend ----
  location = /health {
    proxy_pass http://pushup_de;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ^~ /api/ {
    proxy_pass http://pushup_de;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ^~ /socket.io {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://pushup_de;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # ---- English prefix -> EN backend ----
  location ^~ /en/ {
    proxy_pass http://pushup_en;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Convenience: /en -> /en/
  location = /en {
    return 302 /en/;
  }

  # ---- Default (/...) ----
  # If the user is English (cookie/header), redirect to /en/... so URLs are canonical.
  location / {
    if ($lang = en) {
      return 302 /en$request_uri;
    }

    proxy_pass http://pushup_de;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
