name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    env:
      # Für PRs nur Read-Token, für main Pushes Write-Token.
      # Bei Fork-PRs sind Secrets automatisch nicht verfügbar.
      NX_CLOUD_ACCESS_TOKEN: ${{ github.event_name == 'pull_request' && secrets.NX_CLOUD_ACCESS_TOKEN_READ || secrets.NX_CLOUD_ACCESS_TOKEN_WRITE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Nx Cloud distributed run starten
        run: npx nx-cloud start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="lint,test,build,e2e-ci"

      - name: Nx chain (lint + test + build + e2e-ci)
        run: npx nx run-many -t lint test build e2e-ci --projects=stats-models,stats-data-access,api,web,web-e2e --parallel=3 --configuration=ci

      - name: Nx fix-ci (always)
        if: always()
        run: npx nx fix-ci
