name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    env:
      # Für PRs nur Read-Token, für main Pushes Write-Token.
      # Bei Fork-PRs sind Secrets automatisch nicht verfügbar.
      NX_CLOUD_ACCESS_TOKEN: ${{ github.event_name == 'pull_request' && secrets.NX_CLOUD_ACCESS_TOKEN_READ || secrets.NX_CLOUD_ACCESS_TOKEN_WRITE }}
      # More heap for Angular SSR build + Playwright webServer in CI.
      NODE_OPTIONS: --max-old-space-size=6144

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - uses: nrwl/nx-set-shas@v4

      - name: Nx Cloud distributed run starten
        run: npx nx-cloud start-ci-run --distribute-on="4 linux-medium-js" --stop-agents-after="lint,test,build,e2e-ci"

      - name: Nx chain (lint + test + build + e2e-ci)
        run: |
          npx nx affected -t=build -c=production --localize & \
          npx nx affected -t lint & \
          npx nx affected -t test & \
          npx nx affected -t=e2e-ci -c=ci

      - name: Nx fix-ci (always)
        if: always()
        run: npx nx fix-ci
