name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    env:
      # Für PRs nur Read-Token, für main Pushes Write-Token.
      # Bei Fork-PRs sind Secrets automatisch nicht verfügbar.
      NX_CLOUD_ACCESS_TOKEN: ${{ github.event_name == 'pull_request' && secrets.NX_CLOUD_ACCESS_TOKEN_READ || secrets.NX_CLOUD_ACCESS_TOKEN_WRITE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Nx Cloud distributed run starten
        run: npx nx-cloud start-ci-run --distribute-on="2 linux-medium-js" --stop-agents-after="build"

      - name: Lint
        run: npx nx run-many -t lint --parallel=3

      - name: Test
        run: npx nx run-many -t test --parallel=3 --passWithNoTests

      - name: Build
        run: npx nx run-many -t build --parallel=3

      - name: Nx fix-ci (always)
        if: always()
        run: npx nx fix-ci
